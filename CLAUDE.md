# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **fireplace controller** built on the STM32H5 platform. The controller manages fireplace operation including temperature monitoring, throttle control, and data logging.

### Development Platform
- **Board**: NUCLEO-H533RE development board
- **MCU**: STM32H533RETx (Cortex-M33, LQFP64 package)
- **Code Generation**: STM32CubeMX (version 6.15.0)
- **Build System**: CMake with Ninja generator
- **Toolchain**: ARM GCC (arm-none-eabi-gcc)
- **HAL**: STM32H5xx HAL drivers

### Hardware Components

**External ICs**:
- **DS3231**: Real-time clock (RTC) for timekeeping
- **MAX6675**: Thermocouple-to-digital converter (temperature sensing)
- **HD44780-compatible display**: LCD character display driver

**Control & Storage**:
- **2x PWM throttles**: For controlling fireplace dampers/fans
- **SD card**: Data logging storage

**Communication Interfaces** (to be configured in STM32CubeMX):
- I2C: For DS3231 RTC
- SPI: For MAX6675 thermocouple and SD card
- Parallel interface: For HD44780 display
- PWM timers: For throttle control

## Build Commands

### Configure and Build
```bash
# Configure with preset (first time or after .ioc changes)
cmake --preset Debug

# Build the project
cmake --build build/Debug

# Or use the generated Makefile directly
make
```

### Build Presets
- **Debug**: `-O0 -g3` optimization, includes debug symbols
- **Release**: `-Os -g0` optimization, no debug symbols

### Output Files
- ELF binary: `build/Debug/fireplace.elf`
- Memory map: `fireplace.map`
- Compile commands: `compile_commands.json` (for IDE integration)

## Architecture

### Code Organization

**STM32CubeMX Generated Code** (DO NOT edit manually - will be overwritten):
- `Core/Src/main.c` - Main program (edit only between `USER CODE BEGIN/END` markers)
- `Core/Src/stm32h5xx_it.c` - Interrupt handlers
- `Core/Src/stm32h5xx_hal_msp.c` - HAL MSP initialization
- `Core/Src/stm32h5xx_hal_timebase_tim.c` - Timebase using TIM1
- `Core/Src/system_stm32h5xx.c` - System initialization
- `Core/Inc/*.h` - Header files
- `Drivers/` - STM32 HAL/CMSIS drivers
- `startup_stm32h533xx.s` - Startup assembly code

**User Code Sections**:
All user code must be placed within designated sections:
```c
/* USER CODE BEGIN [tag] */
// Your code here
/* USER CODE END [tag] */
```

**Build Configuration**:
- `CMakeLists.txt` - Main build config (user modifications allowed)
- `cmake/stm32cubemx/CMakeLists.txt` - Auto-generated (DO NOT edit)
- `cmake/gcc-arm-none-eabi.cmake` - Toolchain configuration
- `CMakePresets.json` - Build presets for Debug/Release
- `fireplace.ioc` - STM32CubeMX project file

### Hardware Configuration

The hardware is configured via `fireplace.ioc` using STM32CubeMX. After modifying:
1. Regenerate code in STM32CubeMX
2. Reconfigure CMake: `cmake --preset Debug`

**Linker Scripts**:
- `STM32H533xx_FLASH.ld` - Default (flash execution)
- `STM32H533xx_RAM.ld` - RAM execution

### Build System Details

**Two-Level CMake Structure**:
1. **Root** (`CMakeLists.txt`): User-editable, add custom sources/includes/libraries
2. **Generated** (`cmake/stm32cubemx/CMakeLists.txt`): Auto-generated by CubeMX

**Key Build Variables**:
- `CMAKE_PROJECT_NAME`: fireplace
- `CMAKE_BUILD_TYPE`: Debug or Release
- Target MCU flags: `-mcpu=cortex-m33 -mfpu=fpv4-sp-d16 -mfloat-abi=hard`
- Linker: Uses `nano.specs` for size optimization
- C Standard: C11 (minimum required)

### Adding Custom Code

1. **Add source files**: Edit root `CMakeLists.txt`:
```cmake
target_sources(${CMAKE_PROJECT_NAME} PRIVATE
    # Add user sources here
    src/my_module.c
)
```

2. **Add include paths**: Edit root `CMakeLists.txt`:
```cmake
target_include_directories(${CMAKE_PROJECT_NAME} PRIVATE
    # Add user defined include paths
    include/
)
```

3. **Add compile definitions**: Edit root `CMakeLists.txt`:
```cmake
target_compile_definitions(${CMAKE_PROJECT_NAME} PRIVATE
    # Add user defined symbols
    MY_DEFINE=1
)
```

4. **Add libraries**: Edit root `CMakeLists.txt`:
```cmake
target_link_libraries(${CMAKE_PROJECT_NAME}
    stm32cubemx
    # Add user defined libraries
    my_library
)
```

## Application Architecture

The fireplace controller application should be organized into logical modules:

**Suggested Directory Structure**:
```
src/
  drivers/
    ds3231.c/h      - DS3231 RTC driver (I2C)
    max6675.c/h     - MAX6675 thermocouple driver (SPI)
    hd44780.c/h     - HD44780 display driver
    sdcard.c/h      - SD card driver (SPI + FatFs)
  app/
    temperature.c/h - Temperature monitoring and control logic
    throttle.c/h    - PWM throttle control
    logger.c/h      - Data logging to SD card
    ui.c/h          - User interface (display updates, input handling)
    rtc.c/h         - RTC time management
```

**Key Functional Components**:
- **Temperature Monitoring**: Read thermocouple via MAX6675, implement control algorithms
- **Throttle Control**: PWM output for damper/fan control based on temperature
- **Data Logging**: Periodic logging of temperature, time, throttle positions to SD card
- **Display**: Real-time status display on HD44780 LCD
- **Timekeeping**: DS3231 for accurate timestamps and scheduling

**Peripheral Requirements**:
When configuring `fireplace.ioc`:
- Enable at least 1 I2C peripheral (DS3231)
- Enable at least 1 SPI peripheral (MAX6675 and SD card, or use separate SPI buses)
- Enable 2 PWM timer channels (throttle outputs)
- Configure GPIO for HD44780 parallel interface (typically 6-10 pins)

## Important Notes

- **User Code Markers**: Only edit code within `USER CODE BEGIN/END` sections in generated files
- **CubeMX Regeneration**: Never manually edit files in `cmake/stm32cubemx/` - they're regenerated
- **Toolchain Requirement**: `arm-none-eabi-gcc` must be in PATH
- **TrustZone**: Currently disabled (`Mcu.ContextProject=TrustZoneDisabled`)
- **Timebase**: Using TIM1 instead of SysTick for HAL timebase
- **Memory**: Check `fireplace.map` for memory usage after build
